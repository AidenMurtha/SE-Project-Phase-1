package MBS;

import javax.swing.*;
import javax.swing.SwingUtilities;
import java.awt.*;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;
import javax.swing.border.EmptyBorder;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.util.*;

public class MovieApp {
    public static void main(String[] args) {
        try {
            for (UIManager.LookAndFeelInfo info : UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (Exception e) {
            // fallback to default
        }
        SwingUtilities.invokeLater(LoginScreen::new);
    }
}

class Database {
    static Map<String, Account> accounts = new HashMap<>();
    static List<Movie> movies = new ArrayList<>();
    static Map<String, Cart> carts = new HashMap<>();

    static {
        movies.add(new Movie("Inception", "Nolan", 1900, new String[]{"7:00PM", "9:30PM"}, 8.8f, 15.0f));
        movies.add(new Movie("The Matrix", "Wachowskis", 1901, new String[]{"8:00PM", "10:00PM"}, 9.0f, 12.0f));
    }
}

class Account {
    String email, password;
    int id;

    public Account(String email, String password) {
        this.email = email;
        this.password = password;
        this.id = new Random().nextInt(10000);
    }

    public Cart getCart() {
        return Database.carts.computeIfAbsent(email, k -> new Cart(email));
    }
}

class Cart {
    String accountEmail;
    List<MovieTicket> items = new ArrayList<>();

    public Cart(String email) {
        this.accountEmail = email;
    }

    public void addToCart(Movie movie, String showtime) {
        items.add(new MovieTicket(movie, showtime));
    }

    public float getTotal() {
        return (float) items.stream().mapToDouble(t -> t.movie.cost).sum();
    }

    public void clear() {
        items.clear();
    }
}

class Movie {
    String title, director;
    int movieId;
    String[] showtimes;
    float avgReview, cost;

    public Movie(String title, String director, int movieId, String[] showtimes, float avgReview, float cost) {
        this.title = title;
        this.director = director;
        this.movieId = movieId;
        this.showtimes = showtimes;
        this.avgReview = avgReview;
        this.cost = cost;
    }

    public String toString() {
        return title + " â€” " + director + " | Rating: " + avgReview;
    }
}

class MovieTicket {
    Movie movie;
    String showtime;

    public MovieTicket(Movie movie, String showtime) {
        this.movie = movie;
        this.showtime = showtime;
    }

    public String toString() {
        return movie.title + " @ " + showtime + " ($" + movie.cost + ")";
    }
}

class LoginScreen extends JFrame {
    JTextField emailField;
    JPasswordField passwordField;

    public LoginScreen() {
        setTitle("Login");
        setSize(300, 200);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        JPanel panel = new JPanel(new GridLayout(3, 2, 10, 10));
        panel.setBorder(new EmptyBorder(15, 15, 15, 15));

        panel.add(new JLabel("Email:"));
        emailField = new JTextField();
        panel.add(emailField);

        panel.add(new JLabel("Password:"));
        passwordField = new JPasswordField();
        panel.add(passwordField);

        JButton loginBtn = new JButton("Login");
        loginBtn.addActionListener(e -> login());
        panel.add(loginBtn);

        JButton signupBtn = new JButton("Sign Up");
        signupBtn.addActionListener(e -> signup());
        panel.add(signupBtn);

        add(panel);
        setVisible(true);
    }

    private void login() {
        String email = emailField.getText();
        String pass = new String(passwordField.getPassword());
        Account user = Database.accounts.get(email);
        if (user != null && user.password.equals(pass)) {
            dispose();
            new MainScreen(user);
        } else {
            JOptionPane.showMessageDialog(this, "Invalid login.");
        }
    }

    private void signup() {
        String email = emailField.getText();
        String pass = new String(passwordField.getPassword());
        if (!Database.accounts.containsKey(email)) {
            Database.accounts.put(email, new Account(email, pass));
            JOptionPane.showMessageDialog(this, "Account created. You can now login.");
        } else {
            JOptionPane.showMessageDialog(this, "Account already exists.");
        }
    }
}

class MainScreen extends JFrame {
    Account account;
    JPanel moviePanel;

    public MainScreen(Account account) {
        this.account = account;

        setTitle("Movie Browser - Welcome " + account.email);
        setSize(800, 500);
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setLocationRelativeTo(null);

        moviePanel = new JPanel();
        moviePanel.setLayout(new BoxLayout(moviePanel, BoxLayout.Y_AXIS));
        moviePanel.setBorder(new EmptyBorder(10, 10, 10, 10));

        for (Movie m : Database.movies) {
            JPanel mPanel = new JPanel();
            mPanel.setLayout(new BoxLayout(mPanel, BoxLayout.Y_AXIS));
            mPanel.setBorder(BorderFactory.createTitledBorder(m.title));

            JLabel label = new JLabel(m.toString());
            mPanel.add(label);

            for (String showtime : m.showtimes) {
                JButton timeBtn = new JButton("Book: " + showtime);
                timeBtn.addActionListener(e -> {
                    account.getCart().addToCart(m, showtime);
                    JOptionPane.showMessageDialog(this, "Added to cart: " + m.title + " at " + showtime);
                });
                mPanel.add(timeBtn);
            }

            moviePanel.add(mPanel);
        }

        JScrollPane scrollPane = new JScrollPane(moviePanel);
        add(scrollPane, BorderLayout.CENTER);

        JButton viewCartBtn = new JButton("View Cart");
        viewCartBtn.addActionListener(e -> new CartScreen(account));

        JPanel bottom = new JPanel();
        bottom.add(viewCartBtn);
        add(bottom, BorderLayout.SOUTH);

        setVisible(true);
    }
}

class CartScreen extends JFrame {
    DefaultListModel<String> cartModel = new DefaultListModel<>();
    JList<String> cartList = new JList<>(cartModel);
    JLabel totalLabel = new JLabel();
    Account account;

    public CartScreen(Account account) {
        this.account = account;

        setTitle("Your Cart");
        setSize(400, 350);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());

        refreshCartList();

        cartList.setFont(new Font("Arial", Font.PLAIN, 14));
        cartList.setSelectionMode(ListSelectionModel.SINGLE_SELECTION);
        add(new JScrollPane(cartList), BorderLayout.CENTER);
        totalLabel.setHorizontalAlignment(SwingConstants.CENTER);
        add(totalLabel, BorderLayout.NORTH);

        JPanel bottomPanel = new JPanel();

        JButton removeBtn = new JButton("Remove Selected");
        removeBtn.addActionListener(e -> removeSelectedItem());

        JButton checkoutBtn = new JButton("Checkout");
        checkoutBtn.addActionListener(e -> {
            float total = account.getCart().getTotal();
            int confirm = JOptionPane.showConfirmDialog(this, "Charge $" + total + " to card?", "Confirm Payment", JOptionPane.YES_NO_OPTION);
            if (confirm == JOptionPane.YES_OPTION) {
                account.getCart().clear();
                refreshCartList();
                JOptionPane.showMessageDialog(this, "Payment successful! Thank you.");
            }
        });

        bottomPanel.add(removeBtn);
        bottomPanel.add(checkoutBtn);
        add(bottomPanel, BorderLayout.SOUTH);

        setVisible(true);
    }

    private void refreshCartList() {
        cartModel.clear();
        for (MovieTicket t : account.getCart().items) {
            cartModel.addElement(t.toString());
        }
        totalLabel.setText("Total: $" + account.getCart().getTotal());
    }

    private void removeSelectedItem() {
        int index = cartList.getSelectedIndex();
        if (index != -1) {
            account.getCart().items.remove(index);
            refreshCartList();
        }
    }
}
